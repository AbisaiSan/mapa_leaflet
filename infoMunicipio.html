<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">

    <!--Arquivos leaflet-->
    <script src="/js/leaflet.js"></script>
    <link rel="stylesheet" href="/css/leaflet.css">

    <!--BOOTSTRAP VERSÃO 5-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css">
    <title>Document</title>

    <style>
        #mapid {
            border-radius: 5px;
            width: 70%;
            height: 410px;
        }
    </style>

    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const eixoId = urlParams.get('eixo');
        const municipioId = urlParams.get('municipio');

        const todosOsProjetos = fetch(`http://api.homologacao.promunicipios.ma.gov.br/api/projeto/municipio/${municipioId}`)
            .then(data => data.json())
            .then(projetos => projetos);

        const descricaoPrograma = (programaId) => todosOsProjetos
            .then(projetos => projetos.filter(proj => proj.programa.id == programaId)[0]["programa"]["descricao"]);

        const detalhesProjeto = (projetoId) => todosOsProjetos
            .then(projetos => projetos.filter(proj => proj.id == projetoId)[0]["detalhes"]);

        const carregarProgramas = (eixoId) => {
            todosOsProjetos.then(data => {
                const projetos = data.map(proj => proj.programa).filter(prog => prog.eixo.id == eixoId);

                let programasUnicos = [];
                projetos.forEach(proj => {
                    if (!programasUnicos.some(prog => prog.id == proj.id)) {
                        programasUnicos.push(proj);
                    }
                })
                programasUnicos.forEach(prog => {
                    const select = document.querySelector("#programaSelect");
                    const option = document.createElement("option");
                    option.value = `${prog.id}`;
                    option.text = `${prog.nome}`;
                    select.appendChild(option);
                });
            });
        };

        const carregarProjetos = (programaId) => {
            todosOsProjetos.then(data => {
                const projetos = data.filter(prog => prog.programa.id == programaId);

                let projetosUnicos = [];
                projetos.forEach(proj => {
                    if (!projetosUnicos.some(prog => prog.id == proj.id)) {
                        projetosUnicos.push(proj);
                    }
                })
                projetosUnicos.forEach(proj => {
                    fetch(`http://api.homologacao.promunicipios.ma.gov.br/api/detalhe/projeto/${proj.id}`)
                        .then(data => data.json())
                        .then(detalhe => {
                            //console.log(detalhe)

                            const descricao = detalhe[0].valor; // ? detalhe.descricao : "(Projeto não identificado)";

                            const select = document.querySelector("#projetoSelect");
                            const option = document.createElement("option");
                            option.value = `${proj.id}`;
                            option.text = `${descricao}`;
                            select.appendChild(option);

                        })
                });
            });
        };

        const selecionarEixo = (selectElement) => {
            const selectProgramas = document.querySelector("#programaSelect");
            let length = selectProgramas.options.length;
            for (i = length - 1; i >= 1; i--) {
                selectProgramas.options[i] = null;
            }

            const eixoSelectionadoId = selectElement.value;
            carregarProgramas(eixoSelectionadoId);
        };

        const selecionarPrograma = (selectElement) => {
            const programaSelectionadoId = selectElement.value;

            const elementoDescricaoPrograma = document.querySelector("#descricaoPrograma");
            descricaoPrograma(programaSelectionadoId).then(desc => {
                elementoDescricaoPrograma.innerHTML = `${desc}`;
            });

            const selectProjetos = document.querySelector("#projetoSelect");
            let length = selectProjetos.options.length;
            for (i = length - 1; i >= 1; i--) {
                selectProjetos.options[i] = null;
            }

            carregarProjetos(programaSelectionadoId);
        };

        const selecionarProjeto = (selectElement) => {
            const projetoSelecionadoId = selectElement.value;
            detalhesProjeto(projetoSelecionadoId)
                .then(detalhes => {
                    const nome = detalhes.filter(det => det.coluna == "descricao")[0]["valor"];
                    const beneficiarios = detalhes.filter(det => det.coluna == "beneficiarios")[0]["valor"];
                    const dataInicio = detalhes.filter(det => det.coluna == "data_inicio")[0]["valor"];

                    document.querySelector("#nomeProjeto").innerHTML = `${nome}`;
                    document.querySelector("#dataInicio").innerHTML = `${dataInicio}`;
                    document.querySelector("#beneficiados").innerHTML = `${beneficiarios}`;
                });
        }
    </script>
</head>

<body>
    <!--HEADER-->
    <header>
        <nav style="display: flex;">
            <ul style="display: flex;">
                <li>ADMIN</li>
                <li>ADMIN</li>
                <li>ADMIN</li>
            </ul>
        </nav>
    </header>

    <main class="containerGeral">
        <section style="margin-top: 2%;">

            <div class="container">
                <div style="display: flex; gap: 190px;">
                    <div class="col-4">
                        <div class="card municipioHead ">
                            <div class="card-body">
                                <div class="municipioTitle">
                                    <img src="/img/noun_City_481957.svg" alt="">
                                    <h5 class="card-title nameMunicipio" id="municipioNome"></h5>
                                </div>


                                <div class="seleEixoProg">

                                    <select class="form-select form-select-lg mb-3" aria-label=".form-select-lg example" name="eixo" id="eixoSelect" onchange="selecionarEixo(this)">
                                        <option selected>Selecione um Eixo...</option>                                      
                                    </select>

                                    <select class="form-select form-select-lg mb-3" aria-label=".form-select-lg example" name="programa" id="programaSelect" onchange="selecionarPrograma(this)">
                                        <option selected>Selecione um Programa...</option>
                                    </select>

                                    <select class="form-select form-select-lg mb-3" aria-label=".form-select-lg example" name="projeto" id="projetoSelect" onchange="selecionarProjeto(this)">
                                        <option selected>Selecione um Projeto...</option>
                                    </select>

                                </div>

                                <div class="cardFooter"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-9">
                        <div id="mapid"></div>
                    </div>
                </div>
            </div>

        </section>


        <section style="margin-top: 4%;">
            <div class="container">
                <div class="dadosRelatorio">
                    <div class="municipioTitle municipioHead">
                        <img src="/img/noun_programming_1214182.svg" alt="">
                        <h2>Informações Sobre o Projeto</h2>
                    </div>
                </div>

                <div class="dadosRelatorioPrograma">
                    <div class="TDadosPrograma">
                        <ul>
                            <li>Projeto</li>
                            <li>Data de início</li>
                            <li>N° Beneficiados</li>
                            <li>Ações</li>
                        </ul>
                    </div>


                    <div class="cardDadosPrograma">
                        <ul>
                            <li id="nomeProjeto"></li>
                            <li id="dataInicio"></li>
                            <li id="beneficiados"></li>
                            <li title="Clique aqui para baixar"><i style="font-size: 30px;" class="far fa-file-pdf"></i></li>
                            <li title="Clique aqui para baixar"><i style="font-size: 30px;" class="far fa-file-excel"></i></li>
                        </ul>
                    </div>

                    <div class="descricaoPrograma">
                        <h3>Descrição do programa</h3>
                        <p id="descricaoPrograma">Escolha um programa para ver a sua descrição.</p>
                    </div>
                </div>
            </div>
        </section>
    </main>
    <script src="/mapaInfoMunicipio.js"></script>
    <script src="/js/index.js"></script>

    <!-- <div class="selectEixoPrograma">
<select style="width: 500px;" class="form-select form-select-lg mb-3" aria-label=".form-select-lg example">
    <option selected>Selecione um Eixo...</option>
    <div id="listEixos"></div>
    <option value="1">EDUCAÇÃO E CULTURA</option>
    <option value="2">Saúde</option>
    <option value="3">Segurança Pública</option>
    <option value="3">ESPORTE E LAZER</option>

</select>

<select class="form-select form-select-lg mb-3" aria-label=".form-select-lg example">
    <option selected>Selecione um Programa...</option>
    <div id="listEixos"></div>
    <option value="1">Bolsa Escola</option>
    <option value="2">Centros Especializados de Assistência Social (CREAS)</option>
    <option value="3">Escola Digna</option>
</select>
</div> -->
    <script>
        const select = document.querySelector("#eixoSelect");
        const municipioNome = document.querySelector("#municipioNome");

        fetch('http://api.homologacao.promunicipios.ma.gov.br/api/eixo')
            .then(data => data.json())
            .then(eixoList => eixoList.forEach(eixo => {
                const option = document.createElement("option");
                option.value = `${eixo.id}`;
                option.text = `${eixo.nome}`;
                select.appendChild(option);
            }))
            .then(_ => {
                if (eixoId) select.value = eixoId;
            })

        fetch(`http://api.homologacao.promunicipios.ma.gov.br/api/municipio/id/${municipioId}`)
            .then(data => data.json())
            .then(municipio => {
                municipioNome.innerHTML = `${municipio.nome}`;
            });

        carregarProgramas(eixoId);
    </script>

</body>

</html>